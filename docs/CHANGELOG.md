# Changelog

## 2026-02-05
- Add tile and imposition limits for faster test runs (`--max-labels`, `--max-pages`).
- Record imposition and tile limits in manifests.
- Fix text vertical alignment calculations for label rendering.
- Add tile options to override text alignment, weight, and size, plus cluster alignment controls.
- Add a one-step `run` command that renders tiles and imposes in one invocation.
- Add `tests/conftest.py` to ensure repo imports resolve in pytest.
- Add deterministic geometry tests for label grid placement and scale-to-fit math.
- Add LBX integrity tests for zip structure, asset references, namespaces, and bounds.
- Remove CLI overrides for vertical alignment to keep argparse minimal.
- Add row-aware label clustering to avoid merging labels across rows.
- Add LBX tests to ensure label clusters do not span multiple rows.
- Remove CLI subcommands and simplify to a single LBX-to-Avery pipeline.
- Switch XML parsing to defusedxml to satisfy Bandit security checks.
- Add verbose progress output for the single-command pipeline.
- Normalize label text rendering to a fixed 8 pt bold style for consistency.
- Adjust verbose output to use progress counts instead of listing every file.
- Disable auto-shrink for text so label fonts stay consistent.
- Use gap clustering to pick a more stable label split threshold.
- Throttle progress logging to every 10 LBX files plus final completion.
- Re-enable auto-shrink and reduce default text size to 7.5 pt for more consistent labels.
- Add text overlap detection while rendering tiles.
- Use separator lines and per-row gap thresholds to split labels more reliably.
- Add label boundary documentation in `docs/LABEL_BOUNDARIES.md`.
- Add background grid clustering for multi-label LBX sheets.
- Prefer separator-based splitting over background grid when lines exist.
- Improve background grid clustering by testing row multipliers and merging image-only clusters.
- Enforce a 5 pt minimum font size when auto-shrinking text and report clamp counts.
- Add a progress bar for tile rendering.
- Trim extreme gaps when computing clustering thresholds to better split labels.
- Defer overlap warnings until after the tile progress bar completes.
- Add label validation warnings for missing text and image-after-text ordering.
- Merge loose text into image-only groups when they share a row.
- Insert category labels based on LBX file names (black background with white text).
- Restrict multi-row background grid grouping to a small whitelist.
- Add a per-row pairing pass (single row height) to fix image/text mismatches.
- Add a whitelist for pairing image/text order in `MINIFIG-accessories-all`.
- Wrap category label text and replace hyphens with spaces.
- Sort LBX processing order by numeric category prefixes.
- Add `MINIFIG-weapon_3` to the pairing whitelist.
- Impose labels in column-first order instead of row-first.
- Log low label-count LBX files to `output/label_counts.log`.
- Use PATH `rm` in run.sh for the preferred coreutils variant.
- Update label-count test to account for category labels.
- Shrink all images to 95% of their box and center them to reduce bleed risk.
- Keep multi-row grouping for `CLIP-flexible` but restrict loose text merging to a whitelist.
- Center clusters using visual text bounds instead of full text boxes.
- Cap image upscaling at 2x while keeping the 95% shrink.
- Split large LBX groups into multiple label clusters when they contain many text entries.
- Expand the loose text merge whitelist to cover MINIFIG clothing/hair, NATURE flowers, and OTHER shooter labels.
- Merge text-only groups into image-only groups within the same row for whitelisted LBX files.
- Fix text-merge whitelist entries to use the actual LBX stems (MINIFIG category/hair, NATURE-flower, OTHER-shooter_1).
- Add `--stop-before-rendering` to stop after label collection for faster checks.
- Log multi-image labels to `output/multi_image_labels.log`.
- Print timing stats after the pipeline completes.
- Use scaled visual bounds (including image scale caps) to improve centering.
- Split multi-image clusters for `CLIP-clip_3` and `ANGLE-wedge_plate_63` using text pairing.
- Merge text-only clusters into image-only clusters for multi-image split files.
- Allow multi-image splitting even when only one text is present in a cluster.
- Document label boundary exceptions and whitelists.
- Add v40 baseline fixtures and tests for label counts and multi-image labels.
- Add `refresh_v40_baseline.py` to regenerate v40 baseline fixtures.
- Add periodicity-based row and column clustering with gap-based fallback.
- Skip periodicity when splitting large XML groups to avoid oversplitting.
- Add general image-text matching with score-based fallback to pairing.
- Start Phase 3 with recursive segmentation of oversized clusters.
- Mark Phase 3 (recursive segmentation) as done in [docs/REFACTOR_PLAN.md](docs/REFACTOR_PLAN.md).
- Add label bbox invariant and rendered page smoke tests.
- Document PyMuPDF dependency in [docs/INSTALL.md](docs/INSTALL.md).
- Mark Phase 2 (general image-text matching) as done in [docs/REFACTOR_PLAN.md](docs/REFACTOR_PLAN.md).
- Add [docs/REFACTOR_PLAN.md](docs/REFACTOR_PLAN.md) to track refactor phases.
- Split the pipeline into `brickarchitect_label_converter` modules and keep `lbx_to_avery_5167.py` as a wrapper entry point.
- Mark Phase 4 (modularization) as done in [docs/REFACTOR_PLAN.md](docs/REFACTOR_PLAN.md).
- Add `pip_requirements.txt` with the core runtime dependencies.
- Use a `balc` import alias for `brickarchitect_label_converter` modules.
- Merge adjacent numeric text fragments for `INDEX-slope` to form `SLOPE 45-55-75`.
- Add `pyproject.toml` and `VERSION` for packaging metadata.
- Update [docs/INSTALL.md](docs/INSTALL.md) to install dependencies via `pip_requirements.txt`.
- Refresh README documentation links and update the testing command.
- Add documentation stubs for code architecture, file structure, roadmap, and troubleshooting.
- Filter PyMuPDF swig deprecation warnings in pytest config.
- Update render smoke test to use `get_flattened_data` when available.

## 2026-02-04
- Add plan document for the LBX to Avery 5167 conversion workflow.
- Add LBX to Avery 5167 imposition script with calibration and manifest output.
- Add a test covering label clustering and PDF output for a sample LBX file.
- Fix polyline rendering for draw:poly objects in the PDF output.
- Refresh README and add install and usage documentation.
- Fix label rendering orientation so text and images are upright.
- Add an optional flag to draw sticker outlines on output pages.
- Add run.sh helper script to generate Avery 5167 output.
- Remove Avery template file and bake geometry defaults into the script.
- Add tile rendering and PDF imposition pipeline using vector tiles.
- Normalize label text to ASCII to avoid missing glyphs.
